using Xunit;
using WorkflowEngine.Misc;
using WorkflowEngine.Test.ActionIntegrationTests;
using System.Threading;

namespace WorkflowEngine.Test
{
    public class WorkFlowIntegrationTest
    {
       // [Fact]
        internal void Execute()
        {
            // Arrange
            Workflow workflow = new Workflow(GetWorkflow(), DC.InitialDependencyContainerReturnNonSupportiveStrategy());

            // Act
            WorkflowException exception = Assert.ThrowsAny<WorkflowException>(() => workflow.ExecuteAsync(GetRequestData(), CancellationToken.None));

            // Assert
            Assert.Equal("WorkflowDefinition is not set", exception.Message);
        }

        private string GetRequestData()
        {
            return "{ \"is_sofia_enabled\": 1, \"count_success_t_user_1h\" : 0, \"count_fails_t_user_1h\" : 0, \"count_risk_declines_user_1h\" : 0, \"count_risk_declines_user_1d\" : 0, \"count_billingCountries_ip_1d\" : 0, \"count_billingCountries_ip_7d\" : 0, \"count_billingCountries_ip_30d\" : 0, \"count_docs_ip_1d\" : 0, \"count_docs_ip_7d\" : 0, \"count_docs_ip_30d\" : 0, \"count_devices_ip_1d\" : 0, \"count_devices_ip_7d\" : 0, \"count_devices_ip_30d\" : 0, \"count_cards_ip_1d\" : 0, \"count_cards_ip_7d\" : 0, \"count_cards_ip_30d\" : 0, \"count_phones_ip_1d\" : 0, \"count_phones_ip_7d\" : 0, \"count_phones_ip_30d\" : 0, \"count_emails_ip_1d\" : 0, \"count_emails_ip_7d\" : 0, \"count_emails_ip_30d\" : 0, \"count_billingCountries_doc_1d\" : 0, \"count_billingCountries_doc_7d\" : 0, \"count_billingCountries_doc_30d\" : 0, \"count_ipCountries_doc_1d\" : 0, \"count_ipCountries_doc_7d\" : 0, \"count_ipCountries_doc_30d\" : 0, \"count_devices_doc_1d\" : 0, \"count_devices_doc_7d\" : 0, \"count_devices_doc_30d\" : 0, \"count_cards_doc_1d\" : 0, \"count_cards_doc_7d\" : 0, \"count_cards_doc_30d\" : 0, \"count_phones_doc_1d\" : 0, \"count_phones_doc_7d\" : 0, \"count_phones_doc_30d\" : 0, \"count_emails_doc_1d\" : 0, \"count_emails_doc_7d\" : 0, \"count_emails_doc_30d\" : 0, \"count_billingCountries_phone_1d\" : 0, \"count_billingCountries_phone_7d\" : 0, \"count_billingCountries_phone_30d\" : 0, \"count_ipCountries_phone_1d\" : 0, \"count_ipCountries_phone_7d\" : 0, \"count_ipCountries_phone_30d\" : 0, \"count_devices_phone_1d\" : 0, \"count_devices_phone_7d\" : 0, \"count_devices_phone_30d\" : 0, \"count_cards_phone_1d\" : 0, \"count_cards_phone_7d\" : 0, \"count_cards_phone_30d\" : 0, \"count_docs_phone_1d\" : 0, \"count_docs_phone_7d\" : 0, \"count_docs_phone_30d\" : 0, \"count_emails_phone_1d\" : 0, \"count_emails_phone_7d\" : 0, \"count_emails_phone_30d\" : 0, \"count_success_t_phone_1h\" : 0, \"count_fails_t_phone_1h\" : 0, \"count_risk_declines_phone_1h\" : 0, \"count_risk_declines_phone_1d\" : 0, \"count_billingCountries_email_1d\" : 0, \"count_billingCountries_email_7d\" : 0, \"count_billingCountries_email_30d\" : 0, \"count_ipCountries_email_1d\" : 0, \"count_ipCountries_email_7d\" : 0, \"count_ipCountries_email_30d\" : 0, \"count_phones_email_1d\" : 0, \"count_phones_email_7d\" : 0, \"count_phones_email_30d\" : 0, \"count_devices_email_1d\" : 0, \"count_devices_email_7d\" : 0, \"count_devices_email_30d\" : 0, \"count_cards_email_1d\" : 0, \"count_cards_email_7d\" : 0, \"count_cards_email_30d\" : 0, \"count_docs_email_1d\" : 0, \"count_docs_email_7d\" : 0, \"count_docs_email_30d\" : 0, \"count_success_t_email_1h\" : 0, \"count_fails_t_email_1h\" : 0, \"count_risk_declines_email_1h\" : 0, \"count_risk_declines_email_1d\" : 0, \"count_emails_card_1d\" : 0, \"count_emails_card_7d\" : 0, \"count_IP_card_1d\" : 0, \"count_IP_card_7d\" : 0, \"count_success_dep_card_1d\" : 0, \"count_fails_dep_card_1h\" : 0, \"count_billingCountries_card_1d\" : 0, \"count_billingCountries_card_7d\" : 0, \"count_billingCountries_card_30d\" : 0, \"count_ipCountries_card_1d\" : 0, \"count_ipCountries_card_7d\" : 0, \"count_ipCountries_card_30d\" : 0, \"count_phones_card_1d\" : 0, \"count_phones_card_7d\" : 0, \"count_phones_card_30d\" : 0, \"count_devices_card_1d\" : 0, \"count_devices_card_7d\" : 0, \"count_devices_card_30d\" : 0, \"count_docs_card_1d\" : 0, \"count_docs_card_7d\" : 0, \"count_docs_card_30d\" : 0, \"count_success_t_card_1h\" : 0, \"count_fails_t_card_1h\" : 0, \"count_risk_declines_card_1h\" : 0, \"count_risk_declines_card_1d\" : 0 }";
        }

        private string GetWorkflow()
        {
            // @".\workflow.xml"
            // string res = File.ReadAllText(path);
            return "<Workflow>\r\n  <!--START-->\r\n  <Start />\r\n  <!--DecisionState 1 approved, 2 rejected, 0 indterm-->\r\n  <Condition name=\"IsSophiaActive\">\r\n    <test expression=\"{0} > 0\">\r\n      <parameter type=\"appData\" value=\"is_sofia_enabled\" />\r\n    </test>\r\n    <iftrue>     \r\n      <Strategy name=\"CountersConnectorStrategy\" output=\"CountersConnectorStrategy_Result\" saveAs=\"jNode\" />\r\n      <Connector name=\"MemoCountersConnector\" output=\"MemoCountersConnector_Result\" saveAs=\"jNode\">\r\n        <parameter type=\"appData\" name=\"userId\" value=\"requisites.user_id\" />\r\n        <parameter type=\"appData\" name=\"session_ip\" value=\"requisites.session.ip\" />\r\n        <parameter type=\"appData\" name=\"document_number\" value=\"requisites.documents[?(@.type == 'Passport')].number\" />\r\n        <parameter type=\"appData\" name=\"phone\" value=\"requisites.phone\" />\r\n        <parameter type=\"appData\" name=\"email\" value=\"requisites.email.value\" />\r\n        <parameter type=\"appData\" name=\"card_hash\" value=\"requisites.card_hash\" />\r\n      </Connector>     \r\n      <!--DecisionState 1 approved, 2 rejected, 0 indterm-->\r\n      <Condition name=\"SetDecision\">\r\n        <test expression=\"{0} > 0 \">\r\n          <parameter type=\"appData\" value=\"CountersConnectorStrategy_Result..REJECT_COUNT\" />\r\n        </test>\r\n        <iftrue>\r\n          <DataStore name=\"SetRejected\" output=\"DecisionState\" expression=\"2\" />\r\n        </iftrue>\r\n        <iffalse>\r\n          <DataStore name=\"SetApproved\" output=\"DecisionState\" expression=\"1\" />\r\n        </iffalse>\r\n      </Condition>\r\n    </iftrue>\r\n    <iffalse>\r\n      <DataStore name=\"SetIndeterminated\" output=\"DecisionState\" expression=\"0\" />\r\n    </iffalse>\r\n  </Condition>\r\n  <CustomAction name=\"MemoTransactionStoreAction\" output=\"MemoTransactionStoreAction_Result\">\r\n    <parameter type=\"constant\" name=\"transaction_type\" value=\"Deposit\" />\r\n    <parameter type=\"appData\" name=\"transaction_id\" value=\"transaction_id\" />\r\n    <parameter type=\"appData\" name=\"billing_country\" value=\"session.cashier_country\" />\r\n    <parameter type=\"appData\" name=\"email\" value=\"requisites.email\" />\r\n    <parameter type=\"appData\" name=\"phone\" value=\"phone\" />\r\n    <parameter type=\"appData\" name=\"device\" value=\"session.agent\" />\r\n    <parameter type=\"appData\" name=\"user_id\" value=\"user_id\" />\r\n    <parameter type=\"appData\" name=\"session_ip\" value=\"session.ip\" />\r\n    <parameter type=\"appData\" name=\"document_number\" value=\"documents.[0].number\" />\r\n    <parameter type=\"appData\" name=\"card_hash\" value=\"card_hash\" />\r\n    <parameter type=\"appData\" name=\"order_id\" value=\"merchant_order_id\" />\r\n    <parameter type=\"appData\" name=\"amount\" value=\"amount\" />\r\n    <parameter type=\"appData\" name=\"device_fingerprint\" value=\"fingerprint\" />\r\n    <parameter type=\"appData\" name=\"user_ip\" value=\"session.ip\" />\r\n    <parameter type=\"appData\" name=\"currency\" value=\"currency\" />\r\n    <parameter type=\"const\" name=\"ip_country\" value=\"UA\" />\r\n    <parameter type=\"const\" name=\"card_country\" value=\"UA\" />\r\n  </CustomAction>\r\n  <Finish />\r\n</Workflow>";
        }
    }
}
